if (self.CavalryLogger) { CavalryLogger.start_js(["CxE2W"]); }

__d("XMessengerSeqIDCheckController",["XController"],function(a,b,c,d,e,f){e.exports=b("XController").create("/async/messenger_seq_id_check/",{})},null);
__d("MessengerSyncSeqIDSanityCheck",["requireCond","Arbiter","cr:885544","ChannelClientID","FBLogger","FBMqttChannel","LogHistory","MercurySingletonProvider","MercurySyncConstants","MercurySyncDeltaHolder","MercurySyncFakeDFFSender","MessengerSyncEventEmitter","XMessengerSeqIDCheckController","clearInterval","cr:1069930","gkx","promiseDone","setIntervalAcrossTransitions"],function(a,b,c,d,e,f){"use strict";var g=b("LogHistory").getInstance("seqid_sanity_check");a=function(){a.get=function(){return h.get()};a.getForFBID=function(a){return h.getForFBID(a)};function a(c){var d=this;this.$3=[];this.$5=function(){if(!navigator.onLine)return;var a=b("XMessengerSeqIDCheckController").getURIBuilder().getURI();b("cr:885544")?new(b("cr:885544"))().setURI(a).setAllowCrossPageTransition(!0).setPayloadHandler(d.$7).send():b("cr:1069930")&&b("promiseDone")(b("cr:1069930")(a.toString()),d.$7)};this.$7=function(c){c=c.seqID;if(!c){b("FBLogger")("mercury_sync").mustfix("received no seqID from server in live check");return}var e=b("MercurySyncDeltaHolder").getForFBID(d.$1).getLastSeqID();e=c-e;if(e>a.SEQ_ID_DELTA_TOLERANCE){var f=b("FBMqttChannel").getConnectionState();d.$3.push({timestamp:Date.now(),mqttState:f,numSeqIdsBehind:e,serverSeqID:c});d.$3.length>1&&(b("FBLogger")("mercury_sync").warn("Stale seqID! multiple large deltas (device: %s): %s",b("ChannelClientID").getID(),JSON.stringify(d.$3)),g.log("Stale seqID! multiple large deltas",d.$3),b("gkx")("1097694")&&d.$8({isStale:!0}),b("gkx")("826581")&&b("MercurySyncFakeDFFSender").getForFBID(d.$1).sendGlobalDFF())}else Math.abs(e)>a.SEQ_ID_DELTA_TOLERANCE?b("FBLogger")("mercury_sync").warn("Server lagging seqID! delta is %s",e):e==0&&d.$6()};this.$1=c}var c=a.prototype;c.init=function(){var c=this;this.$2=b("setIntervalAcrossTransitions")(this.$5,a.INTERVAL_MS);this.$4=b("Arbiter").subscribe(b("MercurySyncConstants").ARBITER_EVENT_INVALID_STATE_RECOVER,function(){c.$6()});this.$5();return this};c.stop=function(){b("clearInterval")(this.$2);this.$3=[];this.$4&&b("Arbiter").unsubscribe(this.$4);return this};c.$8=function(a){b("MessengerSyncEventEmitter").emit("SYNC_INVALID_STATE_STALE",a)};c.$6=function(){this.$3=[],b("gkx")("1097694")&&this.$8({isStale:!1})};return a}();a.INTERVAL_MS=60*5*1e3;a.SEQ_ID_DELTA_TOLERANCE=20;var h=new(b("MercurySingletonProvider"))(a);e.exports=a},null);